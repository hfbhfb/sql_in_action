-- 第 22 篇练习题参考答案
-- 练习题 1：如何获得 sales_monthly 表中按照产品统计的销量前三名和相应的月份？

SELECT product AS "产品", ym "年月", amount "销量", rk "名次"
  FROM (
SELECT product, ym, amount,
       RANK() OVER (PARTITION BY product ORDER BY amount DESC) AS rk
  FROM sales_monthly) t
 WHERE rk <= 3
 ORDER BY product, rk;

产品|年月  |销量    |名次|
---|-------|--------|--|
桔子|201906|11524.00| 1|
桔子|201905|11423.00| 2|
桔子|201904|11327.00| 3|
苹果|201906|11560.00| 1|
苹果|201905|11459.00| 2|
苹果|201904|11341.00| 3|
香蕉|201906|11528.00| 1|
香蕉|201905|11469.00| 2|
香蕉|201904|11408.00| 3|

-- 练习题 2：在 sales_monthly 表中，如何知道按照产品统计的最低销量、最高销量以及第三名销量所在的月份？
SELECT product AS "产品", ym "年月", amount "销量",
       FIRST_VALUE(ym) OVER (PARTITION BY product ORDER BY amount DESC ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING) AS "最高销量月份",
       LAST_VALUE(ym) OVER (PARTITION BY product ORDER BY amount DESC ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING) AS "最低销量月份",
       -- SQL Server 不支持 NTH_VALUE
       NTH_VALUE(ym, 3) OVER (PARTITION BY product ORDER BY amount DESC ROWS BETWEEN UNBOUNDED PRECEDING AND UNBOUNDED FOLLOWING) AS "第三名月份"
  FROM sales_monthly
 ORDER BY product, amount DESC;

产品|年月   |销量    |最高销量月份|最低销量月份|第三名月份 |
---|-------|--------|------|------|------|
桔子|201906|11524.00|201906|201801|201904|
桔子|201905|11423.00|201906|201801|201904|
桔子|201904|11327.00|201906|201801|201904|
桔子|201903|11302.00|201906|201801|201904|
桔子|201902|11181.00|201906|201801|201904|
桔子|201901|11099.00|201906|201801|201904|
桔子|201812|10988.00|201906|201801|201904|
桔子|201811|10942.00|201906|201801|201904|
桔子|201810|10838.00|201906|201801|201904|
桔子|201809|10788.00|201906|201801|201904|
桔子|201808|10680.00|201906|201801|201904|
桔子|201807|10578.00|201906|201801|201904|
桔子|201806|10505.00|201906|201801|201904|
桔子|201805|10465.00|201906|201801|201904|
桔子|201804|10325.00|201906|201801|201904|
桔子|201803|10245.00|201906|201801|201904|
桔子|201802|10183.00|201906|201801|201904|
桔子|201801|10154.00|201906|201801|201904|
苹果|201906|11560.00|201906|201801|201904|
苹果|201905|11459.00|201906|201801|201904|
苹果|201904|11341.00|201906|201801|201904|
苹果|201903|11260.00|201906|201801|201904|
苹果|201902|11202.00|201906|201801|201904|
苹果|201901|11155.00|201906|201801|201904|
苹果|201812|10972.00|201906|201801|201904|
苹果|201811|10900.00|201906|201801|201904|
苹果|201810|10842.00|201906|201801|201904|
苹果|201809|10751.00|201906|201801|201904|
苹果|201808|10696.00|201906|201801|201904|
苹果|201807|10613.00|201906|201801|201904|
苹果|201806|10565.00|201906|201801|201904|
苹果|201805|10400.00|201906|201801|201904|
苹果|201804|10376.00|201906|201801|201904|
苹果|201803|10247.00|201906|201801|201904|
苹果|201802|10211.00|201906|201801|201904|
苹果|201801|10159.00|201906|201801|201904|
香蕉|201906|11528.00|201906|201801|201904|
香蕉|201905|11469.00|201906|201801|201904|
香蕉|201904|11408.00|201906|201801|201904|
香蕉|201903|11288.00|201906|201801|201904|
香蕉|201902|11173.00|201906|201801|201904|
香蕉|201901|11161.00|201906|201801|201904|
香蕉|201812|11056.00|201906|201801|201904|
香蕉|201811|10913.00|201906|201801|201904|
香蕉|201810|10829.00|201906|201801|201904|
香蕉|201809|10798.00|201906|201801|201904|
香蕉|201808|10681.00|201906|201801|201904|
香蕉|201807|10589.00|201906|201801|201904|
香蕉|201806|10502.00|201906|201801|201904|
香蕉|201805|10481.00|201906|201801|201904|
香蕉|201803|10328.00|201906|201801|201904|
香蕉|201804|10322.00|201906|201801|201904|
香蕉|201802|10194.00|201906|201801|201904|
香蕉|201801|10138.00|201906|201801|201904|
